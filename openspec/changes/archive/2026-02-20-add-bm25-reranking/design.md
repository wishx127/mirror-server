## Context

当前项目的 RAG 系统已实现混合检索（Hybrid Retrieval），结合向量检索和关键词检索使用 RRF（Reciprocal Rank Fusion）算法进行结果融合。然而，这种方法存在以下局限：

1. **缺乏细粒度排序**：向量检索和关键词检索各自独立计算得分，RRF 融合仅考虑排名顺序，未考虑文档与查询的实际相关性强度差异
2. **关键词匹配精度不足**：当前使用简单的 ILIKE 匹配，无法处理词形变化、同义词等语义相关性

BM25（Best Matching 25）是一种基于词频统计的经典信息检索算法，能够：

- 计算查询词与文档的实际相关性得分
- 考虑文档长度归一化，避免长文档占据优势
- 支持灵活的参数调整（k1, b）

引入 BM25 作为重排序层，可以在保持现有混合检索架构的同时，显著提升结果相关性。

## Goals / Non-Goals

**Goals:**

- 为知识库检索添加 BM25 重排序功能
- 使用 elasticlunr 库实现 BM25 算法（轻量级、无外部依赖）
- 与现有 HybridRetriever 无缝集成
- 提供可配置的开关和权重参数

**Non-Goals:**

- 不引入 Elasticsearch 或其他外部搜索服务
- 不替换现有的向量检索和关键词检索
- 不支持分布式 BM25 索引（单节点内存索引足够）
- 不修改现有的 API 接口

## Decisions

### 1. 选择 elasticlunr 而非其他 BM25 库

**决策**: 使用 `elasticlunr` 库实现 BM25

**备选方案**:

- `elasticlunr`: 纯 JavaScript 实现，轻量级，易于集成
- `bmini`: 更轻量，但功能较少
- 自行实现 BM25: 需要更多开发时间

**理由**: elasticlunr 是成熟的 JavaScript 全文检索库，提供完整的 BM25 实现且 API 简洁，适合本项目的轻量级需求。

### 2. BM25 索引存储策略

**决策**: BM25 索引存储在应用内存中，按用户隔离

**备选方案**:

- 内存索引: 读写速度快，但重启后需重建
- 数据库存储: 持久化但性能较低
- Redis 缓存: 分布式友好但增加复杂度

**理由**: 知识库文档数量有限（通常数百至数千条），内存索引足够；用户隔离通过 userId 作为索引键前缀实现；启动时自动重建索引。

### 3. 重排序集成点

**决策**: 在 HybridRetriever 的 `_getRelevantDocuments` 方法返回前添加 BM25 重排序阶段

**备选方案**:

- 在 HybridRetriever 内部集成: 紧密耦合，修改现有类
- 作为独立包装器: 更灵活，可插拔

**理由**: 与现有 HybridRetriever 兼容的最简方案，通过扩展选项参数启用，无需大幅修改现有代码。

### 4. 分数融合策略

**决策**: 采用加权线性融合：最终得分 = 向量得分 × 0.7 + BM25 得分 × 0.3

**备选方案**:

- 固定权重: 简单但不灵活
- 可配置权重: 更灵活，用户可根据场景调整
- 层级排序: 先向量/关键词 RRF，再 BM25 重排

**理由**: 与现有 keywordWeight/vectorWeight 保持一致的用户体验；0.7/0.3 是经过验证的有效配比。

### 5. 分词策略

**决策**: 集成 nodejieba 中文分词库，同时支持中英文混合文本处理

**备选方案**:

- `nodejieba`: C++ 绑定，性能最优，支持中英文混合
- `jieba-js`: 纯 JavaScript，性能较低但无编译依赖
- 简单分词: 空格/标点分割，对中文效果差

**理由**: nodejieba 是 Node.js 中性能最好的中文分词库，支持自定义词典和词性标注，适合生产环境；同时支持中英文混合文本，满足多语言需求。

### 6. 多语言支持

**决策**: 实现语言检测和分词路由机制

**备选方案**:

- 单一分词器: 中文优先，其他语言简单分词
- 多分词器路由: 根据语言自动选择最佳分词器

**理由**: 采用 nodejieba 统一处理中英文混合文本，其内置的英文分词能力足以满足需求；对于纯英文文本，nodejieba 也能正确处理。

## Risks / Trade-offs

| 风险           | 描述                                      | 缓解措施                            |
| -------------- | ----------------------------------------- | ----------------------------------- |
| 索引重建耗时   | 用户文档量大时，重建 BM25 索引可能较慢    | 增量更新索引，仅重建新增/删除部分   |
| 内存占用       | 大量用户时内存占用增长                    | 按需创建索引，空闲超时自动释放      |
| 分数不可比     | 向量得分和 BM25 得分范围不同              | 标准化后再融合，或使用 RRF 二次融合 |
| nodejieba 编译 | nodejieba 需要 C++ 编译，部分环境可能失败 | 提供 fallback 到简单分词方案        |

## Migration Plan

1. **Phase 1: 基础实现**
   - 添加 elasticlunr 和 nodejieba 依赖
   - 创建 BM25IndexService 索引管理服务
   - 实现分词器封装（支持中英文）

2. **Phase 2: 核心功能**
   - 实现索引构建、查询、增量更新
   - 扩展 HybridRetriever 支持 BM25 重排序
   - 实现分数融合逻辑

3. **Phase 3: 集成和优化**
   - 添加配置开关和权重参数
   - 内存优化：索引缓存和空闲释放

**回滚策略**: 通过配置开关可快速禁用 BM25 重排序，恢复到原有 RRF 排序行为。

## Resolved Questions

1. **分词方案**: ✅ 集成 nodejieba 中文分词库，支持中英文混合文本
2. **索引持久化**: ✅ 不需要持久化，保持内存索引设计
3. **多语言支持**: ✅ nodejieba 原生支持中英文混合，无需额外处理
